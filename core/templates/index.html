{% extends "base.html" %}

{% block content %}
	<div>
		UUID: {{ uuid }}
	</div>
	<div>
		{% if user.is_authenticated %}
			<a href="{% url 'admin:logout' %}?next={% url 'index' %}">Logout</a>
		{% else %}
			<a href="{% url 'admin:login' %}?next={% url 'index' %}">Login</a>
		{% endif %}
	</div>


	<div>
		{% if player %}

			Player: {{ player.username }}
		{% else %}
			<form method="post" action="{% url 'index' %}">
				{% csrf_token %}
				{{ form }}
				<input type="submit" value="Register">
			</form>
		{% endif %}
	</div>

	<div>
		<a href="{% url 'clear_cookie'%}">Clear cache</a>
	</div>

	{% if user.is_authenticated %}

		<div>
			<a href="#" id="update">Update</a>
			Here are the players: <div id="players"></div>
		</div>
		<div>
			<a href="#" id="randomize">Randomize</a>
			Game setup: <div id="setup"></div>
			Final: <div id="game"></div>
		</div>
	{% else %}
		<div>
			<a href="#" id="get_setups">Refresh</a>
			Game setup: <div id="setup"></div>
			Final: <div id="game"></div>
		</div>

	{% endif %}
{% endblock content %}

{% block script %}
	{{ block.super }}
	<script type="text/javascript">
		function new_setup(player) {

			div = document.createElement("div");
			div.innerHTML = [
				player["username"],

				"Team:",
				player["team"],

				"Volk:",
				player["nation"],
			].join(" ")
			div.classList.add("player-setup")
			return div;
		}

		function update_setup(players, id) {
			$(id).html("");

			players.forEach(function (value){
				$(id).append(new_setup(value))
			});
		}

		function update_setups(data) {
			update_setup(data["setup"]["players"], "#setup");
			update_setup(data["final_setup"], "#game");
		}

		// send every 5min a heartbeat to the server
		setInterval($.ajax, 5 * 60 * 1000, {url: "{% url 'ajax:heartbeat' %}", method: "GET"});
	</script>
	{% if user.is_authenticated %}

	<script type="text/javascript">

		function new_player(player) {

			div = document.createElement("div");
			div.classList.add("player");
			div.classList.add("selected");

			div.id = player["uuid"];
			div.setAttribute("username", player["username"]);
			div.setAttribute("team", 0);
			div.setAttribute("nation", "Random");
			div.innerHTML = player["username"];

			return div;
		}

		function update_players(players, id){
			$(id).html("")

			players.forEach(function(value) {
				$(id).append(new_player(value));
			});
		}

		function get_players(id) {
			$.ajax({
				url: "{% url 'ajax:players' %}",
				method: 'GET',
			})
			.done(function (data) {
				update_players(data["players"], id);
			});
		}

		get_players("#players");
		setInterval(get_players, 3 * 1000, "#players");

		$("#update").click(function (event) {
			get_players("#players");
		});
	</script>

	<script type="text/javascript">

		function get_game_setup() {
			setup = {}
			setup["n_teams"] = 2
			setup["players"] = $(".player.selected").map(
				function (i, val) {
					return {
						id: val.id,
						username: $(val).attr("username"),
						team: Number($(val).attr("team")),
						nation: $(val).attr("nation"),
					}
			}).get();

			return setup;
		}

		function randomize() {
			$.ajax({
				url: "{% url 'ajax:randomize'%}",
				method: 'POST',
				data: {
					json: JSON.stringify(get_game_setup())
				},
				headers: {
					"X-CSRFToken": getCookie('csrftoken'),
				},
				dataType: 'json'
			})
			.done(update_setups);
		}

		$("#randomize").click(randomize);
	</script>

	{% else %}
	<script type="text/javascript">
		function get_setups() {
			$.ajax({
				url: "{% url 'ajax:randomize'%}",
				method: 'GET',
			})
			.done(update_setups);
		}

		get_setups();
		setInterval(get_setups, 5 * 1000);
		$("#get_setups").click(get_setups);

	</script>
	{% endif %}
{% endblock script %}
